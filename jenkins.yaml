---
  - name: Launch Jenkins
    hosts: CI
    
    vars:
      ghUser: "{{ lookup('env', 'GITHUB_USER') }}"
      ghToken: "{{ lookup('env', 'GITHUB_TOKEN') }}"
      acrAddress: "{{ lookup('env', 'ACR_ADDR') }}"
      acrUsername: "{{ lookup('env', 'ACR_UID') }}"
      acrPassword: "{{ lookup('env', 'ACR_PASS') }}"


    tasks:
    - name: remove old repo
      file:
        state: absent
        path: ~/auto
    
    - name: git clone
      git:
        repo: https://{{ ghUser }}:{{ ghToken }}@github.com/Nazar802/jenkinsimage.git
        dest: ~/auto
    
    - name: login to ACR
      docker_login:
        registry: "{{ acrAddress }}"
        username: "{{ acrUsername }}"
        password: "{{ acrPassword }}"

    - name: build and push docker image
      docker_image:
        name: "{{ acrAddress }}/jenkins:ansible"
        build:
          path: ~/auto/Dockerfile
          source: build
        state: present        
        push: yes
